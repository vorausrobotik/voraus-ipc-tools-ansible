---
- name: Get number of processors
  ansible.builtin.command: nproc --all
  register: core_isolation_cpu_count
  changed_when: false

- name: Fail if only one CPU is present
  ansible.builtin.fail:
    msg: 'Core isolation requires at least 2 CPUs. Found only {{ core_isolation_cpu_count.stdout }} CPU(s).'
  when: core_isolation_cpu_count.stdout | int < 2

- name: Normalize isolated core IDs to list
  ansible.builtin.set_fact:
    core_isolation_isolated_core_ids_list: >-
      {{
        core_isolation_isolated_core_ids
        if core_isolation_isolated_core_ids is iterable and core_isolation_isolated_core_ids is not string
        else core_isolation_isolated_core_ids | string | split(',') | map('trim') | list
      }}

- name: Build list of all CPU IDs
  ansible.builtin.set_fact:
    core_isolation_all_cpus: '{{ range(0, core_isolation_cpu_count.stdout | int) | list }}'

- name: Build list of allowed CPU IDs (excluding isolated cores)
  ansible.builtin.set_fact:
    core_isolation_allowed_cpus: "{{ core_isolation_all_cpus | difference(core_isolation_isolated_core_ids_list | map('int') | list) | list }}"

- name: Build comma-separated string of allowed CPUs
  ansible.builtin.set_fact:
    core_isolation_allowed_cpus_str: "{{ core_isolation_allowed_cpus | join(',') }}"

- name: Build comma-separated string of isolated CPUs
  ansible.builtin.set_fact:
    core_isolation_isolated_ids_str: "{{ core_isolation_isolated_core_ids_list | join(',') }}"
